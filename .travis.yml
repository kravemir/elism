language: cpp

dist: trusty
sudo: false

addons:
  apt:
    sources:
      - llvm-toolchain-trusty-3.9
    packages:
      - cmake
      - clang-3.9
      - llvm-3.9-dev
      - llvm-3.9-runtime
      - re2c
      - lemon
      - cloc

install:
  - mkdir -p .local/bin .local/src
  - wget -O .local/bin/lempar.c http://www.sqlite.org/src/raw/tool/lempar.c?name=db1bdb4821f2d8fbd76e577cf3ab18642c8d08d1
  - wget -O .local/src/lemon.c http://www.sqlite.org/src/raw/tool/lemon.c?name=6b0cdffb377e79c6295c40300677688f3d35c21c0154da635642ef82dc3a5836
  - gcc .local/src/lemon.c -o .local/bin/lemon
  - chmod +x .local/bin/lemon
  - export PATH="$(pwd)/.local/bin:$PATH"

before_script:
  - mkdir build

script:
  - sh -c "cd build; cmake ..; make -j3"
  - bash scripts/tests/test_jit.sh
  - bash scripts/tests/test_errors.sh

after_success:
  - cloc "$TRAVIS_BUILD_DIR/src"
  - sh -c 'cd "$TRAVIS_BUILD_DIR/src" wc -l $(find examples/ -name '*.bp' | sort)'
  - sh -c 'cd "$TRAVIS_BUILD_DIR/src" wc -l $(find scripts/tests/ -name '*.bp' | sort)'
